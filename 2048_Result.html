<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="apple-touch-icon" sizes="57x57" href="./apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="./apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="./apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="./apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="./apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="./apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="./apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="./apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="./android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="./favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
<link rel="manifest" href="./manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="./ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<meta charset="UTF-8">
<title>2048</title>
<style>
 body { overscroll-behavior-y: none; }
  #table { border-collapse: collapse; user-select: none; }
  #table td {
    border: 10px solid #bbada0; width: 116px; height: 128px;
    font-size: 50px; font-weight: bold; text-align: center;
  }
  #score { user-select: none; }
  .color-2 { background-color: #eee4da; color: #776e65;}
  .color-4 { background-color: #eee1c9; color: #776e65;}
  .color-8 { background-color: #f3b27a; color: 'white';}
  .color-16 { background-color: #f69664; color: 'white';}
  .color-32 { background-color: #f77c5f; color: 'white';}
  .color-64 { background-color: #f75f3b; color: 'white';}
  .color-128 { background-color: #edd073; color: #776e65;}
  .color-256 { background-color: #edcc62; color: #776e65;}
  .color-512 { background-color: #edc950; color: #776e65;}
  .color-1024 { background-color: #edc53f; color: #776e65;}
  .color-2048 { background-color: #edc22e; color: #776e65;}
</style>
</head>
<body>
<table id="table"></table>
<div>
  <h1 id="info">í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ ì„¤ì • êµ¬íšì—ì„œ javascriptì‚¬ìš©ì„ í—ˆìš©í•˜ì§€ ì•Šê³ ìˆê±°ë‚˜ ë´‰ì‚¬ê¸°ì˜ ì‘ë™ì´ ë©ˆì¶”ì—ˆì„ìˆ˜ ìˆìŠµë„¤ë‹¤. ë”°ë¼ì„œ í˜„ì¬ ì´ ì°½ì„ ì •ìƒì ìœ¼ë¡œ ë ¬ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1>
</div>
<a id="target" style="display: none"></a>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/core.min.js" integrity="sha512-t8vdA86yKUE154D1VlNn78JbDkjv3HxdK/0MJDMBUXUjshuzRgET0ERp/0MAgYS+8YD9YmFwnz6+FWLz1gRZaw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha256.min.js" integrity="sha512-fv28nWHTcWfoN3KBd2fs+YWsirQ+L0b/iIRS7HcNDPSAwxy6oSjRrYjQ+OtJoJz0wUKsVcPYgwcZzK04KfHD0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  const congratulation_audio = new Audio('congratulation.wav');
  const lose_audio = new Audio('2048Lose_Mastering.wav');
  const $info = document.getElementById('info');
  $info.textContent = '';
  /*
  const url = new URL(window.location.href);
  const urlParams = url.searchParams;
  const score = urlParams.get('score');
  const win = urlParams.get('win');
  */
  let score_with_win = undefined;
  let win = undefined;
  let score = undefined;
  let game_window = undefined;
  $info.textContent = 'ê²Œì„ ê²°ê³¼ë¥¼ ê¸°ë¡í•˜ê¸°ìœ„í•œ ì°½ì…ë‹ˆë‹¤. ì°½ì„ ë‹«ì„ì‹œê¸°ë¡ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë¡ì„ ì›í•˜ì§€ ì•Šì„ ê²½ìš° ì´ì°½ì„ ë‹«ê³ , ê¸°ë¡ì„ ì›í•˜ì‹¤ê²½ìš° ì´ì°½ì„ ì—´ì–´ë‘ì‹­ì‹œì˜¤.';
  let test_window = undefined;
  if (location.href == 'http://127.0.0.1:5500/2048_Result.html'){
    test_window = window.open('http://127.0.0.1:5500/popup.html');
  } else if (location.href == 'https://project-dy.github.io/project-dy/2048_Result.html') {
    test_window = window.open('https://project-dy.github.io/project-dy/popup.html')
  };
  let test = undefined;
  if (!test_window) {
    $info.textContent = 'íŒì—…ì°¨ë‹¨ì„ í•´ì œí›„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.'
  } else {
    if (location.href == 'http://127.0.0.1:5500/2048_Result.html'){
      game_window = window.open('http://127.0.0.1:5500/2048.html');
    } else if (location.href == 'https://project-dy.github.io/project-dy/2048_Result.html') {
      game_window = window.open('https://project-dy.github.io/project-dy/2048.html')
    };
  };
  const receiveMessage = async (e) => {
    if(e.data.hasOwnProperty('score')){
      console.log(e);
      console.log(e.data.score);
      console.log(e.data.win);
      console.log(e.data.el);
      win = e.data.win;
      console.log(win);
      // startrecord(parseInt(e.data.score));
      score = e.data.score;
      startrecord(score);
    };
  };
  window.addEventListener("message", receiveMessage, false);
  /*
  let encrypted;

  function el_down(){
    el_value = confirm('ìŠ¤í¬ë¦°ìƒ·ì„ ë‚´ë ¤ë°›ì„ê¹Œìš”?');
    if(el_value){
      el_here = document.getElementById("target"); 
      el_here.href = el;
      el_here.download = '2048_complete.jpg';
      el_here.click();
    }
  }*/
  function start_encrypte(v){
    console.log('encrypte start.');
    encrypted = undefined;
    console.log('reset \'encrypted\(var\)\'.');
    encrypted = CryptoJS.SHA256(v);
    encrypted = String(encrypted);
    console.log(encrypted);
  };
  let encrypted_login;
  let encrypted_login_id;
  let encrypted_login_pw;
  let encrypted_record;

  function cookie_login(n,v){
    start_encrypte(n);
    n = encrypted;
    encrypted_login_id = n;
    start_encrypte(v);
    v = encrypted;
    encrypted_login_pw = v;
    start_encrypte(n+v);
    encrypted_login = encrypted;
    console.log(encrypted_login);
    console.log(encrypted_login_id);
    console.log(encrypted_login_pw);
  };

  function cookie_record(n,v){
    start_encrypte(n);
    n = encrypted;
    v = start_encrypte(v);
    start_encrypte(n+v);
    encrypted_record = encrypted;
    console.log(encrypted_record);
  };
  let cookie_temp_login;
  let cookie_temp_record;
  function cookie(o,p,n,v){ // o=ì‘ì—…, p=ì¡°íšŒì™€ ì‘ì„± êµ¬ë¶„, n=name, v=value(loginì‹œ pw, recordì‹œ ì ìˆ˜)
    if(o == 'login'){
      cookie_login(n,v);
      // cookie_temp_login = 1;
      if(p == 'c' && window.localStorage.getItem(encrypted_login_id) == encrypted_login){ // ì²´í¬
        cookie_temp_login = true;
        console.log('true');
      } else if(p == 'w'){ // ì‘ì„±
        window.localStorage.setItem(encrypted_login_id, encrypted_login);
      };
    } else if(o == 'record'){
      cookie_record(n,v);
      // cookie_temp_record = 1;
      if(p == 'c' && window.localStorage.getItem(encrypted_record) == true){ // ì²´í¬
        cookie_temp_record = window.localStorage.getItem(encrypted_record);
        // cookie_record(encrypted_login,cookie_temp_record);
        if(window.localStorage.getItem(name) == encrypted_record){
          cookie_temp_record = true;
          console.log('true');
        } else{
          cookie_temp_record = false;
          console.log('true');
        };
      } else if(p == 'w'){ // ì‘ì„±
        cookie_record(encrypted_login,score);
        window.localStorage.setItem(encrypted_record,score);
        window.localStorage.setItem(name,encrypted_record);
      };
    };
  }
  function startrecord(n) {
    if (win == 0) { // Lose
      document.write(n+'ì  ìœ¼ë¡œ íŒ¨ë°°!');
      /*try {
        lose_audio.play();
      } catch(e) {
        console.log(`ìŒì•… ì¬ìƒ ë¶ˆê°€. ERROR ë‚´ìš©:${e}`);
      };*/
    } else if (win == 1) {
      document.write(n+'ì  ìœ¼ë¡œ ìŠ¹ë¦¬!');
      /*try {
        congratulation_audio.play();
      } catch(e) {
        console.log(`ìŒì•… ì¬ìƒ ë¶ˆê°€. ERROR ë‚´ìš©:${e}`);
      };*/
    };
    login(n);
  };
  let name;
  let pw;
  let pw1;

  let restart_function = 0
  function login(n){
    console.log(n+'ì ì„ ê¸°ë¡.');
    let game_window_close = 0
    setTimeout(() => {
      // let input_data_empty = 0;
      name = prompt('ë‹¹ì‹ ì˜ ë‹‰ë„¤ì„ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.');
      if(name == null) {
        alert('ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      } else if(name === '') {
        login(n);
        // input_data_empty = 1;
        return;
      };
      pw = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
      if(pw == null) {
        alert('ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      } else if(pw === '') {
        login(n);
        // input_data_empty = 1;
        return;
      };
      /*if(input_data_empty == 1) {
        console.log('empty data');
        return;
      };*/
      console.log(pw);
      if(name){
        console.log('ë‹‰ë„¤ì„: ' + name);
        let name_list = false;
        start_encrypte(name);
        let encrypted_name = encrypted;
        start_encrypte(pw);
        let encrypted_pw = encrypted;
        start_encrypte(name+pw);
        let encrypted_id = encrypted;
        cookie('login','c',name,pw);
        if(window.localStorage.getItem(encrypted_name)){
          name_list = window.localStorage.getItem(encrypted_name);
          console.log(name_list+pw);
          console.log(name_list+encrypted_pw);
          if(name_list == true){
            console.log('ê°€ì…í•„ìš”.');
            pw1 == prompt('ì‹ ê·œ ê°€ì…ì¤‘...\në¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œë²ˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if(pw1 == null){
              console.log('ê°€ì… ì·¨ì†Œë¨.')
              restart_function = 1;
              return;
            } else if(pw == pw1){
              /*if (window.localStorage.getItem(pw1) == true) {
                alert('ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                restart_function = 1;
                return;
              } else{
                // window.localStorage.setItem(name, pw);
                cookie('login','w',name,pw);
                console.log('ì™„ë£Œ');
              };*/
              cookie('login','w',name,pw);
              console.log('ì™„ë£Œ');
            } else{
              console.log('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');
              restart_function = 1;
              alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
              if(true){
                return;
              };
            };
          } else if(window.localStorage.getItem(encrypted_login_id) == encrypted_login){
            console.log('ê¸°ë¡ ë˜ì–´ìˆëŠ” ë‹‰ë„¤ì„.');
          } else{
            console.log('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');
            restart_function = 1;
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            // return;
          };
        } else {
          console.log('ì‹ ê·œ');
          pw1 = prompt('ì‹ ê·œ ê°€ì…ì¤‘...\në¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œë²ˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          start_encrypte(pw1);
          let encrypted_temp1 = encrypted;
          start_encrypte(pw);
          let encrypted_temp2 = encrypted;
          console.log(`${encrypted_temp1}, ${encrypted_temp2}`);
          if(pw1 == null){
            console.log('ê°€ì… ì·¨ì†Œë¨.')
            restart_function = 1;
            // return;
          } else if(window.localStorage.getItem(encrypted_temp1) == true){
            alert('ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.');
            restart_function = 1;
            return;
          } else if(encrypted_temp1 == encrypted_temp2){
            // window.localStorage.setItem(name, pw);
            cookie('login', 'w', name, pw);
            console.log('ì™„ë£Œ');
            alert('ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë³¸ ê³„ì •ì€ ë³¸ ê¸°ê¸°ì— í•œí•˜ì—¬ ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.')
          } else {
            console.log('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');
            restart_function = 1;
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            return;
          };
        };
        if(restart_function == 1){
          restart_function = 0;
          console.log('restart!');
          login(n);
        } else {
          record(n, name, pw);
        };
        // return;
      } else {
        return;
      };
      if(restart_function == 1){
        restart_function = 0;
        console.log('restart!');
        login(n);
      };
    }, 100);;
  }
  /*if(restart_function == 1){
    restart_function = 0;
    login(n);
  };*/
  function record(n, name, pw){
    console.log('ê¸°ë¡ ì‹œì‘');
    if(name === null || pw === null) {
      alert('ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      console.log('ì·¨ì†Œ!');
      return;
    };
    // start_encrypte(pw);
    if(!window.localStorage.getItem(encrypted)) {
      console.log('ì²«ë²ˆì§¸ ê¸°ë¡!');
      // window.localStorage.setItem(pw,n);
      start_encrypte(pw);
      cookie('record','w',pw,n);
      console.log('ê¸°ë¡ ì™„ë£Œ!');
      alert('ê¸°ë¡ì„ ì„±ê³µì ìœ¼ë¡œ ëë§ˆì³¤ìŠµë‹ˆë‹¤!');
    } else{
      console.log('ì´ì „ì˜ ê¸°ë¡ ë°œê²¬!');
      start_encrypte(pw);
      cookie('login','c',name,pw);
      cookie_record(encrypted_login,score);
      const prev = window.localStorage.getItem(encrypted_record);
      if(prev < n){
        // window.localStorage.setItem(pw,n);
        cookie('record','w',pw,n);
        console.log('ìµœê³ ê¸°ë¡ ë‹¬ì„±!');
        alert(n+'ì \nìµœê³ ê¸°ë¡ ë‹¬ì„±!\nì¶•í•˜ë“œë¦½ë‹ˆë‹¤!!ğŸ‰ğŸ‰');
        console.log('ì™„ë£Œ');
        alert('ê¸°ë¡ì„ ì„±ê³µì ìœ¼ë¡œ ëë§ˆì³¤ìŠµë‹ˆë‹¤!');
      } else if(prev > n){
        const prev_temp = prev-n;
        alert(prev_temp+'ì  ì°¨ì´ë¡œ ì•„ì‰½ê²Œ ì‹¤íŒ¨!');
        const want_record = confirm('ê¸°ë¡ì„ ê°±ì‹  í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if(want_record){
          if(confirm('ê¸°ì¡´ê¸°ë¡ì€ ì‚­ì œ ë©ë‹ˆë‹¤.\nê·¸ë˜ë„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
            // window.localStorage.setItem(pw,n);
            cookie('record','w',pw,n);
            console.log('ì™„ë£Œ');
            alert('ê¸°ë¡ì„ ì„±ê³µì ìœ¼ë¡œ ëë§ˆì³¤ìŠµë‹ˆë‹¤!');
          } else{
            console.log('cancled');
          };
          return;
        } else{
          return;
        };
      } else{
        console.log('ë™ì !')
        alert(n+'ì ìœ¼ë¡œ ë™ì ì…ë‹ˆë‹¤.')
      };
    };
  }
</script>
</body>
</html>
